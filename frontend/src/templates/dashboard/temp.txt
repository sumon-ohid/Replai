import * as React from 'react';
import type {} from '@mui/x-date-pickers/themeAugmentation';
import type {} from '@mui/x-charts/themeAugmentation';
import type {} from '@mui/x-data-grid-pro/themeAugmentation';
import type {} from '@mui/x-tree-view/themeAugmentation';
import { alpha, useTheme } from '@mui/material/styles';
import CssBaseline from '@mui/material/CssBaseline';
import Box from '@mui/material/Box';
import Stack from '@mui/material/Stack';
import Paper from '@mui/material/Paper';
import Typography from '@mui/material/Typography';
import Button from '@mui/material/Button';
import IconButton from '@mui/material/IconButton';
import Tooltip from '@mui/material/Tooltip';
import Chip from '@mui/material/Chip';
import Tabs from '@mui/material/Tabs';
import Tab from '@mui/material/Tab';
import InputBase from '@mui/material/InputBase';
import Avatar from '@mui/material/Avatar';
import Badge from '@mui/material/Badge';
import Menu from '@mui/material/Menu';
import MenuItem from '@mui/material/MenuItem';
import Divider from '@mui/material/Divider';
import { motion, AnimatePresence } from 'framer-motion';

// Icons
import AddIcon from '@mui/icons-material/Add';
import RefreshIcon from '@mui/icons-material/RefreshRounded';
import EmailIcon from '@mui/icons-material/EmailRounded';
import HelpOutlineIcon from '@mui/icons-material/HelpOutlineRounded';
import SearchIcon from '@mui/icons-material/SearchRounded';
import ExpandMoreIcon from '@mui/icons-material/ExpandMoreRounded';
import GoogleIcon from '@mui/icons-material/Google';
import MicrosoftIcon from '@mui/icons-material/Microsoft';
import AlternateEmailIcon from '@mui/icons-material/AlternateEmail';
import FilterListIcon from '@mui/icons-material/FilterList';
import AttachmentIcon from '@mui/icons-material/Attachment';
import InboxIcon from '@mui/icons-material/Inbox';
import SendIcon from '@mui/icons-material/Send';
import StarBorderIcon from '@mui/icons-material/StarBorder';
import DeleteOutlineIcon from '@mui/icons-material/DeleteOutline';
import FlagIcon from '@mui/icons-material/Flag';
import ArchiveIcon from '@mui/icons-material/Archive';

// Components
import AppNavbar from './components/AppNavbar';
import Header from './components/Header';
import SideMenu from './components/SideMenu';
import AppTheme from '../shared-theme/AppTheme';
import {
  chartsCustomizations,
  dataGridCustomizations,
  datePickersCustomizations,
  treeViewCustomizations,
} from './theme/customizations';
import axios from 'axios';
import Footer from '../marketing-page/components/Footer';
import CustomizedDataGrid from './components/CustomizedDataGrid';

const apiBaseUrl = import.meta.env.VITE_API_BASE_URL;

const xThemeComponents = {
  ...chartsCustomizations,
  ...dataGridCustomizations,
  ...datePickersCustomizations,
  ...treeViewCustomizations,
};

// Animation variants
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      when: "beforeChildren"
    }
  }
};

const itemVariants = {
  hidden: { opacity: 0, y: 20 },
  visible: { 
    opacity: 1, 
    y: 0,
    transition: {
      type: "spring",
      stiffness: 300,
      damping: 30
    }
  }
};

// Email provider tab interface
interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;
  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`email-tabpanel-${index}`}
      aria-labelledby={`email-tab-${index}`}
      {...other}
    >
      {value === index && (
        <Box sx={{ p: 0 }}>
          {children}
        </Box>
      )}
    </div>
  );
}

// Email Action Toolbar Component
const EmailActionToolbar = ({ onRefresh }: { onRefresh: () => void }) => {
  const theme = useTheme();
  const [filterAnchorEl, setFilterAnchorEl] = React.useState<null | HTMLElement>(null);

  const handleFilterClick = (event: React.MouseEvent<HTMLButtonElement>) => {
    setFilterAnchorEl(event.currentTarget);
  };

  const handleFilterClose = () => {
    setFilterAnchorEl(null);
  };

  return (
    <Box 
      sx={{ 
        display: 'flex', 
        alignItems: 'center', 
        gap: 1,
        flexWrap: 'wrap',
        mb: 2
      }}
    >
      <Tooltip title="Refresh">
        <IconButton 
          onClick={onRefresh}
          sx={{ 
            color: theme.palette.primary.main,
            bgcolor: alpha(theme.palette.primary.main, 0.1),
            '&:hover': {
              bgcolor: alpha(theme.palette.primary.main, 0.2),
            }
          }}
        >
          <RefreshIcon />
        </IconButton>
      </Tooltip>
      
      <Tooltip title="Delete">
        <IconButton color="default">
          <DeleteOutlineIcon />
        </IconButton>
      </Tooltip>

      <Tooltip title="Archive">
        <IconButton color="default">
          <ArchiveIcon />
        </IconButton>
      </Tooltip>

      <Tooltip title="Mark as important">
        <IconButton color="default">
          <FlagIcon />
        </IconButton>
      </Tooltip>

      <Box sx={{ flexGrow: 1 }} />
      
      <Button
        startIcon={<FilterListIcon />}
        endIcon={<ExpandMoreIcon />}
        onClick={handleFilterClick}
        sx={{
          borderRadius: 2,
          textTransform: 'none',
          border: `1px solid ${alpha(theme.palette.divider, 0.8)}`,
          px: 2,
          color: theme.palette.text.secondary,
          bgcolor: alpha(theme.palette.background.paper, 0.5),
        }}
      >
        Filter
      </Button>
      
      <Menu
        anchorEl={filterAnchorEl}
        open={Boolean(filterAnchorEl)}
        onClose={handleFilterClose}
        sx={{ 
          '& .MuiPaper-root': { 
            borderRadius: 2, 
            mt: 1, 
            boxShadow: `0 8px 24px ${alpha(theme.palette.common.black, 0.15)}`,
            border: `1px solid ${alpha(theme.palette.divider, 0.6)}`,
            width: 180
          } 
        }}
        elevation={0}
      >
        <MenuItem onClick={handleFilterClose}>All emails</MenuItem>
        <MenuItem onClick={handleFilterClose}>Unread</MenuItem>
        <MenuItem onClick={handleFilterClose}>With attachments</MenuItem>
        <MenuItem onClick={handleFilterClose}>Starred</MenuItem>
        <MenuItem onClick={handleFilterClose}>Important</MenuItem>
      </Menu>
    </Box>
  );
};

const EmailSearchBar = () => {
  const theme = useTheme();
  
  return (
    <Paper
      elevation={0}
      sx={{
        display: 'flex',
        alignItems: 'center',
        py: 0.5,
        px: 1.5,
        borderRadius: 3,
        mb: 2,
        border: `1px solid ${alpha(theme.palette.divider, 0.6)}`,
        bgcolor: theme.palette.background.paper,
        width: '100%',
        maxWidth: 600,
      }}
    >
      <SearchIcon sx={{ color: 'text.secondary', mr: 1 }} />
      <InputBase
        placeholder="Search emails..."
        sx={{ 
          ml: 1, 
          flex: 1,
          '& .MuiInputBase-input': {
            py: 1.2
          }
        }}
      />
    </Paper>
  );
};

export default function InboxEmail(props: { disableCustomTheme?: boolean }) {
  const theme = useTheme();
  const [loading, setLoading] = React.useState(false);
  const [refreshTrigger, setRefreshTrigger] = React.useState(0);
  const [tabValue, setTabValue] = React.useState(0);

  const handleTabChange = (event: React.SyntheticEvent, newValue: number) => {
    setTabValue(newValue);
  };

  const handleRefresh = () => {
    setRefreshTrigger(prev => prev + 1);
  };

  return (
    <AppTheme {...props} themeComponents={xThemeComponents}>
      <CssBaseline enableColorScheme />
      <Box sx={{ display: 'flex' }}>
        <SideMenu />
        <AppNavbar />
        
        {/* Main content */}
        <Box
          component={motion.div}
          variants={containerVariants}
          initial="hidden"
          animate="visible"
          sx={(theme) => ({
            flexGrow: 1,
            backgroundColor: alpha(theme.palette.background.default, 1),
            overflow: 'auto',
            minHeight: '100vh',
          })}
        >
          <Stack
            spacing={2}
            sx={{
              alignItems: 'center',
              mx: { xs: 2, sm: 3 },
              pb: 2,
              mt: { xs: 8, md: 0 },
            }}
          >
            <Header />
          </Stack>

          {/* Inbox container */}
          <Box
            component={motion.div}
            variants={itemVariants}
            sx={{ 
              px: { xs: 2, sm: 3 }, 
              pb: 4,
              maxWidth: 1400,
              mx: 'auto'
            }}
          >
            <Box sx={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between',
              flexWrap: 'wrap',
              gap: 2, 
              mb: 3 
            }}>
              <Typography 
                variant="h4" 
                component="h1" 
                sx={{ 
                  fontWeight: 700,
                  color: theme.palette.primary.main,
                  textShadow: `0 2px 4px ${alpha(theme.palette.primary.main, 0.2)}`
                }}
              >
                Inbox
              </Typography>
              
              <EmailSearchBar />
            </Box>
            
            <Paper
              elevation={0}
              sx={{
                borderRadius: 3,
                overflow: 'hidden',
                border: `1px solid ${alpha(theme.palette.divider, 0.7)}`,
                mb: 4,
                background: `linear-gradient(to bottom, ${alpha(theme.palette.primary.main, 0.02)}, ${alpha(theme.palette.background.paper, 0.8)})`,
                backdropFilter: 'blur(8px)',
                boxShadow: `0 8px 32px ${alpha(theme.palette.primary.main, 0.12)}`
              }}
            >
              <Box sx={{ 
                borderBottom: 1, 
                borderColor: 'divider',
                px: 3,
                pt: 2,
                background: alpha(theme.palette.primary.main, 0.05)
              }}>
                <Tabs 
                  value={tabValue} 
                  onChange={handleTabChange} 
                  aria-label="email provider tabs"
                  sx={{
                    '& .MuiTabs-indicator': {
                      backgroundColor: theme.palette.primary.main,
                      height: 3,
                      borderTopLeftRadius: 3,
                      borderTopRightRadius: 3,
                    },
                    '& .MuiTab-root': {
                      textTransform: 'none',
                      fontWeight: 600,
                      fontSize: '0.95rem',
                      px: { xs: 1.5, sm: 3 },
                      py: 2,
                    }
                  }}
                >
                  <Tab 
                    icon={<GoogleIcon sx={{ fontSize: 18 }} />} 
                    iconPosition="start" 
                    label="Gmail" 
                  />
                  <Tab 
                    icon={<MicrosoftIcon sx={{ fontSize: 18 }} />} 
                    iconPosition="start" 
                    label="Outlook" 
                  />
                  <Tab 
                    icon={<AlternateEmailIcon sx={{ fontSize: 18 }} />} 
                    iconPosition="start" 
                    label="Custom" 
                  />
                </Tabs>
              </Box>

              <Box sx={{ px: 3, py: 2 }}>
                <EmailActionToolbar onRefresh={handleRefresh} />
              </Box>
              
              <TabPanel value={tabValue} index={0}>
                <CustomizedDataGrid />
              </TabPanel>
              
              <TabPanel value={tabValue} index={1}>
                <Box sx={{ p: 3, textAlign: 'center' }}>
                  <Box
                    sx={{
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      py: 6,
                      px: 3,
                      mb: 2,
                      bgcolor: alpha(theme.palette.background.paper, 0.6),
                      borderRadius: 3,
                      border: `1px dashed ${alpha(theme.palette.divider, 0.7)}`
                    }}
                  >
                    <Avatar
                      sx={{
                        width: 60,
                        height: 60,
                        mb: 2,
                        bgcolor: alpha(theme.palette.primary.main, 0.1),
                        color: theme.palette.primary.main
                      }}
                    >
                      <MicrosoftIcon fontSize="large" />
                    </Avatar>
                    <Typography variant="h6" gutterBottom>
                      Connect Outlook
                    </Typography>
                    <Typography 
                      variant="body2" 
                      color="text.secondary"
                      sx={{ mb: 3, maxWidth: 400 }}
                    >
                      To view your Outlook emails, you need to connect your Microsoft account
                    </Typography>
                    <Button
                      variant="contained"
                      startIcon={<MicrosoftIcon />}
                      disableElevation
                      sx={{
                        borderRadius: 2,
                        py: 1,
                        px: 3,
                        textTransform: 'none',
                        fontWeight: 600
                      }}
                    >
                      Connect Outlook
                    </Button>
                  </Box>
                </Box>
              </TabPanel>
              
              <TabPanel value={tabValue} index={2}>
                <Box sx={{ p: 3, textAlign: 'center' }}>
                  <Box
                    sx={{
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      py: 6,
                      px: 3,
                      mb: 2,
                      bgcolor: alpha(theme.palette.background.paper, 0.6),
                      borderRadius: 3,
                      border: `1px dashed ${alpha(theme.palette.divider, 0.7)}`
                    }}
                  >
                    <Avatar
                      sx={{
                        width: 60,
                        height: 60,
                        mb: 2,
                        bgcolor: alpha(theme.palette.primary.main, 0.1),
                        color: theme.palette.primary.main
                      }}
                    >
                      <AlternateEmailIcon fontSize="large" />
                    </Avatar>
                    <Typography variant="h6" gutterBottom>
                      Configure Custom Email
                    </Typography>
                    <Typography 
                      variant="body2" 
                      color="text.secondary"
                      sx={{ mb: 3, maxWidth: 400 }}
                    >
                      Connect your custom email server using IMAP/SMTP settings
                    </Typography>
                    <Button
                      variant="contained"
                      startIcon={<AddIcon />}
                      disableElevation
                      color="primary"
                      sx={{
                        borderRadius: 2,
                        py: 1,
                        px: 3,
                        textTransform: 'none',
                        fontWeight: 600
                      }}
                    >
                      Add Custom Email
                    </Button>
                  </Box>
                </Box>
              </TabPanel>
            </Paper>

            {/* Email Categories */}
            <Grid container spacing={3} sx={{ mb: 4 }}>
              {[
                { icon: <InboxIcon />, label: 'Inbox', count: 142, color: 'primary' },
                { icon: <SendIcon />, label: 'Sent', count: 89, color: 'success' },
                { icon: <StarBorderIcon />, label: 'Starred', count: 24, color: 'warning' },
                { icon: <AttachmentIcon />, label: 'With Attachments', count: 53, color: 'info' }
              ].map((category, index) => (
                <Grid xs={6} sm={3} key={index}>
                  <Paper
                    component={motion.div}
                    variants={itemVariants}
                    elevation={0}
                    sx={{
                      p: 2,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      borderRadius: 3,
                      border: `1px solid ${alpha(theme.palette.divider, 0.7)}`,
                      background: `linear-gradient(145deg, ${theme.palette.background.paper}, ${alpha(theme.palette[category.color as "primary" | "success" | "warning" | "info"].light, 0.07)})`,
                      boxShadow: `0 4px 20px ${alpha(theme.palette.common.black, 0.05)}`,
                      transition: 'all 0.3s ease',
                      '&:hover': {
                        transform: 'translateY(-4px)',
                        boxShadow: `0 8px 25px ${alpha(theme.palette[category.color as "primary" | "success" | "warning" | "info"].main, 0.15)}`,
                        borderColor: alpha(theme.palette[category.color as "primary" | "success" | "warning" | "info"].main, 0.3)
                      }
                    }}
                  >
                    <Box sx={{ display: 'flex', alignItems: 'center' }}>
                      <Avatar
                        sx={{
                          bgcolor: alpha(theme.palette[category.color as "primary" | "success" | "warning" | "info"].main, 0.1),
                          color: theme.palette[category.color as "primary" | "success" | "warning" | "info"].main,
                          width: 40,
                          height: 40,
                          mr: 2
                        }}
                      >
                        {category.icon}
                      </Avatar>
                      <Typography variant="subtitle2">{category.label}</Typography>
                    </Box>
                    <Chip 
                      label={category.count} 
                      size="small" 
                      color={category.color as "primary" | "success" | "warning" | "info"} 
                      sx={{ 
                        borderRadius: 1.5,
                        fontWeight: 600 
                      }} 
                    />
                  </Paper>
                </Grid>
              ))}
            </Grid>
          </Box>

          <Footer />
        </Box>
      </Box>
    </AppTheme>
  );
}

// Fix the missing Grid import
import Grid from '@mui/material/Grid';